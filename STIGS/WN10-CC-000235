<#
.SYNOPSIS
    Enforces Windows 10 STIG WN10-CC-000235:
    Users must NOT be allowed to ignore Microsoft Defender SmartScreen warnings
    for unverified files in Microsoft Edge.

.DESCRIPTION
    Configures the Edge policy:
      HKLM\SOFTWARE\Policies\Microsoft\Edge\PreventSmartScreenPromptOverrideForFiles = 1
    and ensures SmartScreen is enabled:
      HKLM\SOFTWARE\Policies\Microsoft\Edge\SmartScreenEnabled = 1
    Requires Administrator. A gpupdate/logoff may be needed for full effect.

.NOTES
    Author          : Mitch Adams
    LinkedIn        : https://www.linkedin.com/in/mitchelcadams
    GitHub          : https://github.com/mitchel-adams
    Date Created    : 2025-11-09
    Last Modified   : 2025-11-09
    Version         : 1.0
    STIG-ID         : WN10-CC-000235  (Block override for *unverified file* warnings in Edge)

.REFERENCES
    - Windows 10 STIG mapping: WN10-CC-000235 (Block SmartScreen overrides for unverified files in Edge). 
    - Microsoft Edge policy 'PreventSmartScreenPromptOverrideForFiles'.
#>

# ----- safety: require admin -----
$principal = New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())
if (-not $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Write-Error "Run this script in an elevated PowerShell session (Administrator)."
    exit 1
}

$ErrorActionPreference = 'Stop'

# ----- policy path & values -----
$EdgePolicyPath = 'HKLM:\SOFTWARE\Policies\Microsoft\Edge'

# Value: enable SmartScreen in Edge (recommended so the override setting applies)
$SmartScreenEnabledName = 'SmartScreenEnabled'
$SmartScreenEnabledVal  = 1  # 1 = enabled

# Value: block override for unverified file warnings (this is WN10-CC-000235)
$PreventOverrideFilesName = 'PreventSmartScreenPromptOverrideForFiles'
$PreventOverrideFilesVal  = 1  # 1 = block bypass

# ----- ensure policy key exists -----
if (-not (Test-Path $EdgePolicyPath)) {
    New-Item -Path $EdgePolicyPath -Force | Out-Null
}

# ----- set policies -----
New-ItemProperty -Path $EdgePolicyPath -Name $SmartScreenEnabledName     -PropertyType DWord -Value $SmartScreenEnabledVal     -Force | Out-Null
New-ItemProperty -Path $EdgePolicyPath -Name $PreventOverrideFilesName   -PropertyType DWord -Value $PreventOverrideFilesVal   -Force | Out-Null

# ----- verification output -----
$smart = Get-ItemProperty -Path $EdgePolicyPath -Name $SmartScreenEnabledName -ErrorAction SilentlyContinue
$preventFiles = Get-ItemProperty -Path $EdgePolicyPath -Name $PreventOverrideFilesName -ErrorAction SilentlyContinue

Write-Host "==== Microsoft Edge SmartScreen Policy Status ===="
Write-Host ("SmartScreenEnabled:                        {0}" -f ($smart.$SmartScreenEnabledName))
Write-Host ("PreventSmartScreenPromptOverrideForFiles:  {0}" -f ($preventFiles.$PreventOverrideFilesName))
Write-Host "Compliance target (WN10-CC-000235): PreventSmartScreenPromptOverrideForFiles = 1 (block bypass)."
Write-Host "Note: WN10-CC-000230 (websites) is a separate STIGâ€”do not conflate with this control."

# Optional: apply group policy immediately (uncomment if desired in managed environments)
# gpupdate /target:computer /force
